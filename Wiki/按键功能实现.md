# 按键功能实现

## 数据结构

<img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20200408215035060.png" alt="image-20200408215035060" style="zoom: 67%;" />
```c
/* Key scan variables */
typedef struct
{
    keyTriggerType_t lastValue;        // last state of key, refresh when release
    keyTriggerType_t triggered;        // trigger when a key pressed
    keyTriggerType_t continuous;       // IO state
    u8 triggerState;                   // the EnumKeyTriggerState to match with
}KeyScanStates_t;
```

![image-20200408215017040](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20200408215017040.png)
```c
/* Key IO struct */
typedef struct
{
    // The indirect addressing mode is not supposed to operate a sfr register
    // Parsing string to operate a GPIO in an iteration statement maybe a good idea
    u8 *IOPort1;        // string such like "P49", "P33"
    u8 *IOPort2;
}KeyIO_t;

/* Key function struct
 * Mapping a key and its event function
*/
typedef struct
{
    keyTriggerType_t triggerValue;         // A value mapping with a key pressed state
    FUNCTIONPTR fp_singleClick;            // A event function pointer, related to enum EnumKeyTriggerState
    FUNCTIONPTR fp_comboClick;
    FUNCTIONPTR fp_longPress;
    FUNCTIONPTR fp_multiPress;
}KeyFunc_t;

/* Keys description struct */
typedef struct
{
    u8 KeysNumber;             // Quantity of keys
    KeyIO_t *KeyIO;            // Key IO struct pointer
    
    u8 FuncsNumber;            // Quantity of event functions
    KeyFunc_t *KeyFunc;        // Key function struct pointer
}Keys_t; 
```

## 捋一捋各个状态和思路

- 每个按键对应`IO`字符串 (硬件连接)
- 程序读到的`IO`状态`keyTriggerType_t read_data`
- 触发的功能`u8 triggerState` (来自`KeyScanStates_t`)
- 每个功能对应触发键值`keyTriggerType_t triggerValue` (来自`KeyFunc_t`)
- 每个功能对应的事件函数

当一个按键按下，到对应的功能函数执行，经过的就是这些状态和过程。

![image-20200409024559338](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20200409024559338.png)